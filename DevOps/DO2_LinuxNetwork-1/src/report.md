## Contents :book:
   1. [Инструмент ipcalc](#part-1-инструмент-ipcalc) 
   2. [Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами) 
   3. [Утилита iperf3](#part-3-утилита-iperf3) 
   4. [Сетевой экран](#part-4-сетевой-экран) 
   5. [Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети) 
   6. [Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp) 
   7. [NAT](#part-7-nat) 
   8. [Допополнительно. Знакомство с SSH Tunnels](#part-8-дополнительно-знакомство-с-ssh-tunnels)





## Part 1. Инструмент **ipcalc**
#### 1.1. Сети и маски
##### 1) Адрес сети *192.167.38.54/13* - *192.160.0.0*
![linux](images/192.160.0.0.png)
##### 2.1) Перевод маски *255.255.255.0* в префиксную и двоичную запись - */24*,*11111111.11111111.11111111.00000000*
![linux](images/mask_24.png)
##### 2.2) */15* в обычную и двоичную - *255.254.0.0*,*11111111.11111110.00000000.00000000*
![linux](images/mask_15.png)
##### 2.3) *11111111.11111111.11111111.11110000* в обычную и префиксную - *255.255.255.240*, */28*
![linux](images/mask_28.png)

##### 3) Минимальный и максимальный хост в сети *12.167.38.4* при масках:
##### 3.1)*/8* - min(12.0.0.1),max(12.255.255.254)
![linux](images/host-8.png)
##### 3.2)*11111111.11111111.00000000.00000000* - min(12.167.0.1),max(12.167.255.254)
![linux](images/host-16.png)
##### 3.3)*255.255.254.0* - min(12.167.38.1),max(12.167.39.254)
![linux](images/host-23.png)
##### 3.4)*/4* - min(0.0.0.1),max(15.255.255.254)
![linux](images/host-4.png)



#### 1.2. localhost

##### Можно ли обратиться к приложению, работающему на localhost, со следующими IP: 
###### localhost - это так называемый локальный хост. Можно сказать, что обращаясь к localhost вы обращаетесь к тому же самому компьютеру, на котором сейчас работаете. Вот диапазон IP-адресов, которые предназначены для создания локальных сетей. *127.0.0.1 - 127.255.255.255*
##### *194.34.23.100* - нет, не входит в диапозон
##### *127.0.0.2* - да
##### *127.1.0.1* - да
##### *128.0.0.1* - нет,не входит в диапозон

#### 1.3. Диапазоны и сегменты сетей
![linux](images/class_ip.png)
##### 1) Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных:
##### Публичные: *134.43.0.2*,*172.20.250.4*,*172.0.2.1*,*192.172.0.1*, *172.68.0.2*, *192.169.168.1*
##### Частные: *10.0.0.45*, *192.168.4.2*, *172.16.255.255*, *10.10.10.10*,
##### 2) Какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: 
- *10.10.0.2*
- *10.10.10.10*
- *10.10.1.255*

## Part 2. Статическая маршрутизация между двумя машинами

##### С помощью команды `ip a` посмотри существующие сетевые интерфейсы.


![linux](images/ip_a_eu.png)

![linux](images/ip_a_li.png)

##### Опиши сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*.

###### ws1
![ws1](images/yaml_ws1.png)


###### ws2

![ws2](images/yaml_ws2.png)

##### Выполни команду `netplan apply` для перезапуска сервиса сети.
- ![ws1](images/netplan_ws1.png)
- ![ws2](images/netplan_ws2.png)


#### 2.1. Добавление статического маршрута вручную
##### Добавь статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`.
- ![ws1](images/ipr_ws1.png)
- ![ws2](images/ipr_ws2.png)
##### Пропингуй соединение между машинами.
- ![ws2](images/ping_ws2.png)
- ![ws1](images/ping_ws1.png)


##### Добавь статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*.
- ![ws1](images/yaml2_ws1.png)
- ![ws2](images/yaml2_ws2.png)
##### Пропингуй соединение между машинами.
- ![ws2](images/ping2_ws2.png)
- ![ws1](images/ping2_ws1.png)

## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения
![ws](images/speed.png)

##### Переведи и запиши в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps.
##### 8 Mbps в MB -  1MB
##### 100 MB в Kbps - 800000 
##### 1 Gbps в Mbps - 1000 

#### 3.2. Утилита **iperf3**
##### Измерь скорость соединения между ws1 и ws2.
![ws1](images/iperf3.png)

![ws2](images/iperf3_2.png)

## Part 4. Сетевой экран

#### 4.1. Утилита **iptables**
##### Создай файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:
```shell
#!/bin/sh

# Удаление всех правил в таблице «filter» (по-умолчанию).
iptables -F
iptables -X
```
![ws](images/rules.png)
##### Нужно добавить в файл подряд следующие правила:
##### 1) На ws1 примени стратегию, когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5).

![linux](images/firewall_ws1.png)

##### 2) На ws2 примени стратегию, когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5).

![linux](images/firewall_ws2.png)

##### Запусти файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`.

![linux](images/chmod_ws1.png)

![linux](images/chmod_ws2.png)


- В первом файле (ws1) применяется стратегия, при которой сначала устанавливается запрещающее правило для echo reply, а затем разрешающее. Это означает, что по умолчанию машина не будет отвечать на ping, но последующее разрешающее правило позволит ей это делать.

- Во втором файле (ws2) применяется стратегия, при которой сначала устанавливаются разрешающие правила для портов 22 и 80, а также для echo reply, а затем следует запрещающее правило для echo reply. В этом случае, поскольку разрешающее правило для echo reply стоит выше в списке, машина будет отвечать на ping, а запрещающее правило не будет иметь эффекта, так как пакеты уже будут разрешены.

#### 4.2. Утилита **nmap**
##### Командой **ping** найди машину, которая не «пингуется», после чего утилитой **nmap** покажи, что хост машины запущен.
![linux](images/nmap.png)

## Part 5. Статическая маршрутизация сети

`-` Пока что мы соединяли всего две машины, но теперь пришло время для статической маршрутизации целой сети.

**== Задание ==**
##### Подними пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)).

#### 5.1. Настройка адресов машин
##### Настрой конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.

![linux](images/part5_network.png)

- R1 & WS11


![linux](images/yaml_r1_ws11.png)

- R2


![linux](images/yaml_r2.png)

- WS22 & WS 21

![linux](images/yaml_ws22_ws21.png)

##### Перезапусти сервис сети. Если ошибок нет, то командой `ip -4 a` проверь, что адрес машины задан верно. Также пропингуй ws22 с ws21. Аналогично пропингуй r1 с ws11.
`ip -4 a`
- r1


![linux](images/ip_r1.png)

- ws11


![linux](images/ip_ws11.png)

- r2


![linux](images/ip_r2.png)

- ws22


![linux](images/ip_ws22.png)

- ws21


![linux](images/ip_ws21.png)

`ping`
- ws21 - ws22


![linux](images/ping_ws22.png)
- ws11 - r1


![linux](images/ping_r1.png)


--------------------------------------------

#### 5.2. Включение переадресации IP-адресов
##### Для включения переадресации IP, выполни команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1`
*При таком подходе переадресация не будет работать после перезагрузки системы.*

![linux](images/sysctl_w_net_r1.png)

![linux](images/sysctl_w_net_r2.png)


##### Открой файл */etc/sysctl.conf* и добавь в него следующую строку:
`net.ipv4.ip_forward = 1`
*При использовании этого подхода, IP-переадресация включена на постоянной основе.*

![linux](images/sysctl_w_net_r1_nano.png)

![linux](images/sysctl_w_net_r2_nano.png)
--------------------------------------------

##### Настрой маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавь `default` перед IP роутера в файле конфигураций.

![linux](images/yam_ws11.png)

![linux](images/yam_ws21.png)
![linux](images/yam_ws22.png)

##### Вызови `ip r` и покажи, что добавился маршрут в таблицу маршрутизации.

![linux](images/ipr_ws11.png)

![linux](images/ipr_ws22.png)

![linux](images/ipr_ws21.png)


##### Пропингуй с ws11 роутер r2 и покажи на r2, что пинг доходит. Для этого используй команду:
`tcpdump -tn -i eth0`

![linux](images/tcpdump1.png)

![linux](images/tcpdump2.png)


#### 5.4. Добавление статических маршрутов
##### Добавь в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:
```shell
# Добавь в конец описания сетевого интерфейса eth1:
- to: 10.20.0.0
  via: 10.100.0.12
```


![linux](images/netplan_r1.png)

![linux](images/netplan_r2.png)

##### Вызови `ip r` и покажи таблицы с маршрутами на обоих роутерах.

![linux](images/ipr_r1.png)


![linux](images/ipr_r2.png)


##### Запусти команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`
- Если для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, это означает, что в таблице маршрутизации есть более конкретный маршрут для этой подсети, который имеет больший приоритет, чем маршрут по умолчанию.

![linux](images/ip_r_list.png)

#### 5.5. Построение списка маршрутизаторов

##### Запусти на r1 команду дампа:
`tcpdump -tnv -i eth0`
##### При помощи утилиты **traceroute** построй список маршрутизаторов на пути от ws11 до ws21.

![linux](images/tcpdump_r1.png)


![linux](images/traceroute.png)

- Команда **traceroute** используется для определения маршрута, который проходит пакет от источника к назначению. При этом, traceroute отправляет последовательность пакетов с увеличивающимся значением TTL (Time to Live), которое определяет максимальное количество маршрутизаторов, через которые может пройти пакет.


#### 5.6. Использование протокола **ICMP** при маршрутизации
##### Запусти на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
##### Пропингуй с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`

![linux](images/tcpdump_n_i.png)


![linux](images/ping_10.30.0.111.png)


## Part 6. Динамическая настройка IP с помощью **DHCP**

##### Для r2 настрой в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
##### 1) Укажи адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2:
```shell
subnet 10.100.0.0 netmask 255.255.0.0 {}

subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50;
    option routers 10.20.0.1;
    option domain-name-servers 10.20.0.1;
}
```
##### 2) В файле *resolv.conf* пропиши `nameserver 8.8.8.8`.
![linux](images/subnet_mask.png)


![linux](images/resolv_conf.png)

##### Перезагрузи службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузи при помощи `reboot` и через `ip a` покажи, что она получила адрес. Также пропингуй ws22 с ws21.

![linux](images/system_restart.png)

![linux](images/dynamic_ip.png)

![linux](images/ping_10.20.0.20.png)

##### Укажи MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`.

![linux](images/macadress_ws11.png)

##### Для r1 настрой аналогично r2, но сделай выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проведи аналогичные тесты.

- Укажем адрес маршрутизатора по-умолчанию,адрес внутренней сети. По аналогии r2

![linux](images/subnet_r1.png)

- Зададим правила для жесткой маски

![linux](images/mask_r1.png)

- Укажем DNS

![linux](images/resolv_r1.png)

- Перезапускаем ws11, в настройках сети  ВМ указываем наш МАК-адрес

![linux](images/mask_adr_ws11.png)

- Появился динамический Ip с жесткой привязкой МАК-адреса

![linux](images/dynamic_ip_ws11.png)
##### Запроси с ws21 обновление ip адреса.


![linux](images/dhclient1.png)


![linux](images/dhclient2.png)


![linux](images/dhclient3.png)

 - ![linux](images/options.png)


  - ![linux](images/dhcl.png)


## Part 7. **NAT**

##### В файле */etc/apache2/ports.conf* на ws22 и r1 измени строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделай сервер Apache2 общедоступным.
![linux](images/listen_80_r1.png)

![linux](images/listen_80_ws22.png)

##### Запусти веб-сервер Apache командой `service apache2 start` на ws22 и r1.



![linux](images/apache_start_r1.png)


![linux](images/apache_start_ws22.png)


##### Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
##### 1) Удаление правил в таблице filter - `iptables -F`;
##### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`;
##### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`.
##### Запусти файл также, как в Части 4.
##### Проверь соединение между ws22 и r1 командой `ping`.

![alt text](images/fw3.png)

*При запуске файла с этими правилами, ws22 не должна «пинговаться» с r1.*

![linux](images/ping_1.png)

##### Добавь в файл ещё одно правило:
##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**.
##### Запусти файл также, как в Части 4.
##### Проверь соединение между ws22 и r1 командой `ping`.

![linux](images/fw1.png)

*При запуске файла с этими правилами, ws22 должна «пинговаться» с r1.*

![linux](images/ping_2.png)


##### Добавь в файл ещё два правила:
##### 5) Включи **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0).
##### 6) Включи **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.

![linux](images/fw2.png)

##### Проверь соединение по TCP для **SNAT**: для этого с ws22 подключиться к серверу Apache на r1 командой:
```telnet [адрес] [порт]```

![linux](images/telnet.png)

##### Проверь соединение по TCP для **DNAT**: для этого с r1 подключиться к серверу Apache на ws22 командой ```telnet``` (обращаться по адресу r2 и порту 8080).

![linux](images/telnet_r1.png)



## Part 8. Дополнительно. Знакомство с **SSH Tunnels**


##### Запусти на r2 фаервол с правилами из Части 7.
##### Запусти веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* измени строку ```Listen 80``` на ```Listen localhost:80```).
![linux](images/ports.png)

##### Воспользуйся *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.



![linux](images/local_TCP.png)


##### Воспользуйся *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.

![linux](images/remote_TCP.png)

##### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейди во второй терминал (например, клавишами Alt + F2) и выполни команду:

![linux](images/telnet_ws21.png)


![linux](images/telnet_ws11.png)


![alt text](image.png)

:smile: :blush: :school: